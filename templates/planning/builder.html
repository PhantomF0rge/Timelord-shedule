{% extends "layout.html" %}
{% block content %}
<section class="hero glass">
  <div class="hero-body">
    <h1 class="h1">Планировщик расписания</h1>
    <p class="lead">Создавайте занятия: выберите группу, предмет, преподавателя, слот и аудиторию — система подскажет конфликты.</p>
  </div>
</section>

<section class="glass" style="padding:16px">
  <form id="builder-form" onsubmit="return false;">
    <div class="grid grid-2">
      <label>
        <div class="search-label">Дата</div>
        <input type="date" id="b-date" class="search-input" />
      </label>

      <label>
        <div class="search-label">Группа</div>
        <select id="b-group" class="search-input">
          {% for g in groups %}
            <option value="{{ g.id }}">{{ g.code or g.name }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        <div class="search-label">Предмет</div>
        <select id="b-subject" class="search-input">
          {% for s in subjects %}
            <option value="{{ s.id }}">{{ s.name or s.title }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        <div class="search-label">Преподаватель</div>
        <select id="b-teacher" class="search-input">
          {% for t in teachers %}
            <option value="{{ t.id }}">{{ t.full_name or (t.last_name ~ ' ' ~ (t.first_name or '') ~ ' ' ~ (t.middle_name or '')) }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        <div class="search-label">Слот (пара)</div>
        <select id="b-slot" class="search-input">
          {% for s in slots %}
            <option value="{{ s.id }}">
              №{{ s.order_no or s.order }} — {{ s.start_time }}–{{ s.end_time }}
            </option>
          {% endfor %}
        </select>
      </label>

      <label>
        <div class="search-label">Аудитория</div>
        <select id="b-room" class="search-input">
          {% for r in rooms %}
            <option value="{{ r.id }}">{{ r.number }} ({{ r.capacity }} мест)</option>
          {% endfor %}
        </select>
      </label>

      <label>
        <div class="search-label">Тип занятия</div>
        <select id="b-lesson-type" class="search-input">
          {% for lt in lesson_types %}
            <option value="{{ lt.id }}">{{ lt.name or lt.title }}</option>
          {% endfor %}
        </select>
      </label>

      <label>
        <div class="search-label">Формат</div>
        <select id="b-remote" class="search-input">
          <option value="0">Очный</option>
          <option value="1">Дистанционный (СДО)</option>
        </select>
      </label>
    </div>

    <div style="margin-top:12px; display:flex; gap:8px;">
      <button id="b-check" class="btn">Проверить конфликты</button>
      <button id="b-create" class="btn">Создать занятие</button>
    </div>

    <div id="b-result" style="margin-top:12px" class="muted"></div>
  </form>
</section>

<script>
  // Простые заглушки — фронт стучится в уже существующие API /api/v1/schedule и т.п., если нужны отдельные endpoints — добавим.
  (function () {
    const $ = (sel, root=document)=>root.querySelector(sel);
    const result = $("#b-result");
    const btnCheck = $("#b-check");
    const btnCreate = $("#b-create");

    function val(id){ const el = document.getElementById(id); return el ? el.value : null; }

    async function postJSON(url, body){
      const r = await fetch(url, {method:"POST", headers:{"Content-Type":"application/json"}, body: JSON.stringify(body)});
      return { ok: r.ok, status: r.status, json: r.ok ? await r.json() : null, text: !r.ok ? await r.text() : null };
    }

    function payload(){
      return {
        date: val("b-date"),
        group_id: Number(val("b-group")),
        subject_id: Number(val("b-subject")),
        teacher_id: Number(val("b-teacher")),
        time_slot_id: Number(val("b-slot")),
        room_id: Number(val("b-room")),
        lesson_type_id: Number(val("b-lesson-type")),
        is_remote: val("b-remote")==="1"
      };
    }

    btnCheck?.addEventListener("click", async ()=>{
      const body = payload();
      // пока проверка на бэке в /planning/check-conflicts (добавим позже),
      // показываем заглушку, чтобы страница открывалась
      result.textContent = "Проверка (демо): конфликтов не найдено.";
    });

    btnCreate?.addEventListener("click", async ()=>{
      const body = payload();
      // Пока нет конечной точки — также заглушка
      result.textContent = "Создание (демо): занятие создано.";
    });
  })();
</script>
{% endblock %}
