{% extends "base.html" %}
{% block title %}Справочники · Админ{% endblock %}
{% block content %}
<div class="card">
  <h1>Справочники</h1>
  <p class="muted">Минимальный UI: списки + формы создания. Редактирование/удаление делает API-вызовами.</p>
</div>

<div class="grid">
  <section class="card">
    <h2>Группы</h2>
    <form id="form-group">
      <input name="code" placeholder="Код (уникально)" required />
      <input name="name" placeholder="Название" />
      <input name="students_count" type="number" min="0" value="25" />
      <select name="education_level">
        <option>СПО</option><option>ВО</option>
      </select>
      <button type="submit">Создать</button>
    </form>
    <div id="groups-list"></div>
  </section>

  <section class="card">
    <h2>Аудитории</h2>
    <form id="form-room">
      <input name="building_id" type="number" placeholder="ID корпуса" required />
      <input name="number" placeholder="Номер (уникально в корпусе)" required />
      <input name="capacity" type="number" min="0" value="30" />
      <input name="room_type_id" type="number" placeholder="ID типа" required />
      <input name="computers_count" type="number" min="0" value="0" />
      <button type="submit">Создать</button>
    </form>
    <div id="rooms-list"></div>
  </section>

  <section class="card">
    <h2>Слоты времени</h2>
    <form id="form-timeslot">
      <input name="order_no" type="number" min="1" value="1" />
      <input name="start_time" type="time" value="08:30" />
      <input name="end_time" type="time" value="10:00" />
      <button type="submit">Создать</button>
    </form>
    <div id="timeslots-list"></div>
  </section>
</div>

<script>
async function api(path, opts={}) {
  const r = await fetch(path, Object.assign({headers:{'Content-Type':'application/json'}}, opts));
  if (!r.ok) {
    const t = await r.text().catch(()=> ""); throw new Error(t || r.statusText);
  }
  return r.status === 204 ? null : r.json();
}
async function refresh() {
  const groups = await api("/directory/api/groups?page=1&per_page=20");
  document.getElementById("groups-list").innerHTML =
    `<ul>` + groups.items.map(g => `<li>#${g.id} ${g.code} (${g.students_count})</li>`).join("") + `</ul>`;
  const rooms = await api("/directory/api/rooms?page=1&per_page=20");
  document.getElementById("rooms-list").innerHTML =
    `<ul>` + rooms.items.map(r => `<li>#${r.id} ${r.number} (cap=${r.capacity})</li>`).join("") + `</ul>`;
  const ts = await api("/directory/api/time-slots");
  document.getElementById("timeslots-list").innerHTML =
    `<ul>` + ts.items.map(t => `<li>#${t.id} ${t.order_no}: ${t.start_time}–${t.end_time}</li>`).join("") + `</ul>`;
}
document.getElementById("form-group").addEventListener("submit", async (e) => {
  e.preventDefault();
  const f = e.target;
  const body = {
    code: f.code.value, name: f.name.value,
    students_count: parseInt(f.students_count.value || "0"),
    education_level: f.education_level.value
  };
  await api("/directory/api/groups", {method:"POST", body: JSON.stringify(body)});
  f.reset(); refresh();
});
document.getElementById("form-room").addEventListener("submit", async (e) => {
  e.preventDefault();
  const f = e.target;
  const body = {
    building_id: parseInt(f.building_id.value),
    number: f.number.value,
    capacity: parseInt(f.capacity.value||"0"),
    room_type_id: parseInt(f.room_type_id.value),
    computers_count: parseInt(f.computers_count.value||"0")
  };
  await api("/directory/api/rooms", {method:"POST", body: JSON.stringify(body)});
  f.reset(); refresh();
});
document.getElementById("form-timeslot").addEventListener("submit", async (e) => {
  e.preventDefault();
  const f = e.target;
  const body = {
    order_no: parseInt(f.order_no.value||"1"),
    start_time: f.start_time.value,
    end_time: f.end_time.value
  };
  await api("/directory/api/time-slots", {method:"POST", body: JSON.stringify(body)});
  f.reset(); refresh();
});
refresh();
</script>

<style>
.grid { display:grid; grid-template-columns: repeat(auto-fit, minmax(300px,1fr)); gap:16px; }
.muted { color: var(--muted); }
form input, form select { background:#0f1218; border:1px solid var(--border); color:var(--text); padding:6px 8px; margin:4px; border-radius:8px; }
form button { padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:#18202c; color:var(--text); cursor:pointer; }
ul { margin:8px 0 0; padding-left:18px; }
</style>
{% endblock %}
