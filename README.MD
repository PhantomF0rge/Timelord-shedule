# 1) Архитектура и модульность

## Технологии

* Фронтенд: HTML + чистый JS (fetch, History API), без SPA-фреймворков. Для автодополнений — простые JS-виджеты.
* Бэкенд: Flask + Blueprints, SQLAlchemy, Alembic (Flask-Migrate), Jinja2 для базового шаблона.
* БД: PostgreSQL (рекомендовано) или SQLite на раннем этапе.
* Сессии: анонимный visitor\_id (cookie) + localStorage для «последней группы».
* Авторизация: ролевая (админ, преподаватель, гость/студент).

## Модульная разбивка (Blueprint’ы)

1. **core** — базовые страницы, статика, конфиг, ошибки, health.
2. **search** — поиск групп/преподов/дисциплин, подсказки (typeahead), выдача расписаний.
3. **schedule** — чтение/публикация расписаний, подсветка состояний пар, календарь.
4. **auth** — вход/выход преподавателей и админов.
5. **directory** — справочники: группы, преподаватели, дисциплины, корпуса/кабинеты, типы пар, слоты времени.
6. **planning** — генерация расписания (по датам/неделям), назначение дисциплин и групп преподавателям, лимиты.
7. **constraints** — проверка конфликтов и правил (вместимость, компьютеры, занятость, лимиты часов).
8. **homework** — ДЗ от преподавателя к конкретной паре.
9. **teacher** — ЛК преподавателя: его расписание, статистика часов/дней, смена кабинета, назначение ДЗ.
10. **admin** — ЛК администратора: CRUD справочников, редактор расписания, просмотр конфликтов/логов.
11. **reports** — отчёты/экспорт (pdf/csv), рабочие часы, загрузка аудиторий, отклонения.
12. **import\_export** — загрузка исходных данных (csv/xlsx), выгрузка расписаний.
13. **api** — публичные/внутренние REST-эндпоинты для фронта (JSON).

> Каждый модуль — отдельная папка с `__init__.py`, `routes.py`, `services.py`, `schemas.py` (pydantic/маршмаллоу при желании), `validators.py`.

## Пример структуры проекта

```
college_schedule/
  app.py
  config.py
  extensions.py (db, migrate, login_manager, cache)
  blueprints/
    core/
    search/
    schedule/
    auth/
    directory/
    planning/
    constraints/
    homework/
    teacher/
    admin/
    reports/
    import_export/
    api/
  services/
    scheduling_engine/
    conflict_checks/
    assignments/
  models/  (все SQLAlchemy модели, можно по доменам)
  templates/
    base.html
    ... (микрошаблоны для вставок)
  static/
    css/, js/, img/
  migrations/
  tests/
    unit/, api/, e2e/
```

# 2) Страницы (фронтенд)

### Публичные (без авторизации)

* **Главная /**
  Поле поиска (группа/преподаватель/дисциплина), недавний выбор (из localStorage), расписание «на сегодня» выбранной группы, переключение дня/недели.
* **Расписание группы /group/<code>**
  Таблица пар за день/неделю. Цветовые статусы: прошла/идёт/предстоит/дистанционка. Отображение: предмет, ФИО, время, аудитория/СДО, № пары, тип пары, корпус, ДЗ. Перерывы — как отдельные строки.
* **Расписание преподавателя /teacher/<id>**
  Аналогично, плюс суммарные часы/пары за выбранный период (только просмотр, без ЛК-фич).
* **Поиск /search**
  Инпуты с автодополнением (группы, преподаватели, дисциплины). Результаты — ссылки на соответствующие страницы.

### Для преподавателей (после входа)

* **ЛК преподавателя /teacher/me**
  Календарь, счётчики рабочих дней/часов/пар, быстрые действия: задать ДЗ, сменить кабинет (если доступно), фильтры по неделе/месяцу.
* **Назначение ДЗ /homework/assign?lesson\_id=**
  Форма: текст, файлы/ссылки (опционально), дедлайн (опционально).

### Для администраторов

* **Панель администратора /admin**
  Дашборд: конфликты, ближайшие недели, статус генерации.
* **Справочники /admin/directory/**
  CRUD: группы, преподаватели, дисциплины, кабинеты, типы кабинетов, корпуса, типы занятий, слоты времени.
* **Настройки лимитов /admin/limits**
  Часы преподавателей/неделю, нерабочие дни, отпуска, доступность по дням.
* **Учебные планы /admin/curricula**
  Назначение группам перечня дисциплин с объёмами часов.
* **Назначения /admin/assignments**
  Привязка дисциплин/групп к преподавателям (для генератора).
* **Генерация /admin/planning**
  Выбор периода (диапазон дат, «следующая неделя», etc.), установка нерабочих дней, запуск генерации, предпросмотр, список предупреждений/ошибок до сохранения.
* **Редактор расписания /admin/schedule-editor**
  Drag\&drop/формы для ручной корректировки, интерактивная проверка конфликтов в реальном времени.
* **Отчёты /admin/reports**
  Экспорты (CSV/PDF): загрузка аудиторий, рабочие часы преподавателей, итоговые ведомости.

# 3) API (бэкенд, JSON, через Blueprint `api`)

### Публичные

* `GET /api/v1/suggest?q=&type=group|teacher|subject&limit=10` — подсказки.
* `GET /api/v1/schedule/group/<code>?date=YYYY-MM-DD&range=day|week` — расписание группы.
* `GET /api/v1/schedule/teacher/<id>?date=...&range=...` — расписание преподавателя.
* `GET /api/v1/lesson/<id>` — подробности пары (для модалок).

### Авторизованные (преподаватель)

* `POST /api/v1/homework` — назначить/обновить ДЗ: `{lesson_id, text, attachments?, deadline?}`.
* `POST /api/v1/lesson/<id>/change-room` — смена кабинета (с проверками).

### Админские

* Справочники CRUD:
  `POST/PUT/DELETE /api/v1/admin/groups|teachers|subjects|rooms|room-types|buildings|lesson-types|time-slots`
* Учебные планы и привязки:
  `POST/PUT/DELETE /api/v1/admin/curricula`, `/admin/assignments`
* Лимиты/доступность/нерабочие дни:
  `POST/PUT/DELETE /api/v1/admin/limits`, `/admin/availability`, `/admin/holidays`
* Генерация:
  `POST /api/v1/admin/planning/generate` — запуск (с параметрами периода),
  `GET /api/v1/admin/planning/preview` — просмотр черновика,
  `POST /api/v1/admin/planning/commit` — запись в основное расписание.
* Конфликты:
  `GET /api/v1/admin/conflicts?period=...` — список текущих конфликтов.

> Все операции записи проходят через слой **constraints**: API возвращает детальные причины отказа (коды ошибок и поля).

# 4) Фронтенд-детали (UX/JS)

* **Сохранение выбранной группы**:
  `localStorage.setItem('last_group', 'ИТ-101')` + cookie `visitor_id` (аноним).
* **Автоподсказки**:
  дебаунс (300 мс), подсветка совпадающей части, клавиатурная навигация.
* **Подсветка статусов пар** (CSS классы):

  * `lesson--past`, `lesson--now`, `lesson--next`, `lesson--remote`, `lesson--break`.
* **Перерывы**: отрисовка «пустой» пары с подписью «перерыв» и интервалом.
* **Календарь** (ученик/преподаватель): неделя/месяц, кнопки «сегодня», переключение стрелками.
* **Graceful degradation**: вся функциональность доступна без JS (основные страницы — серверный рендер), а JSON-данные — для динамики.
* **Иконки типов пар** (лекция/практика/зачёт/экзамен).
* **Оптимизация**: кэширование подсказок в памяти (на сессию), ETag на ответы расписаний.

# 5) Модель данных (приблизительная ERD)

### Основные сущности

* **User** (`id`, `email`, `password_hash`, `role` in {ADMIN, TEACHER}, `teacher_id?`, `is_active`)
* **Teacher** (`id`, `full_name`, `short_name`, `external_id?`)
* **Group** (`id`, `code`, `name`, `students_count`, `education_level` in {ВО, СПО}, `external_id?`)
* **Subject** (`id`, `name`, `short_name`, `external_id?`)
* **Building** (`id`, `name`, `address`, `type` in {ВО, СПО})
* **RoomType** (`id`, `name`, `requires_computers` bool?, `sports` bool?)
* **Room** (`id`, `building_id`, `number`, `capacity`, `room_type_id`, `computers_count`)
* **LessonType** (`id`, `name`) — лекция, практика, зачёт, экзамен, …
* **TimeSlot** (`id`, `order_no`=1..N, `start_time`, `end_time`) — «1 пара 08:30–10:00» и т.д.
* **CalendarDay** (`id`, `date`, `is_working_day`, `note?`)
* **Holiday** (`id`, `date`, `name`)
* **TeacherAvailability** (`id`, `teacher_id`, `weekday`, `available_from`, `available_to`, `is_day_off`) + исключения по датам.
* **WorkloadLimit** (`id`, `teacher_id`, `hours_per_week`)
* **Curriculum** (`id`, `group_id`, `subject_id`, `total_hours`, `hours_per_week?`)
* **Assignment** (`id`, `teacher_id`, `group_id`, `subject_id`) — кто что ведёт в принципе.
* **Schedule** (`id`, `date`, `time_slot_id`, `group_id`, `subject_id`, `lesson_type_id`, `teacher_id`, `room_id?`, `is_remote` bool, `note?`)
* **Homework** (`id`, `schedule_id`, `text`, `attachments?`, `deadline?`, `created_by_teacher_id`, `created_at`)
* **ChangeLog** (`id`, `entity`, `entity_id`, `action`, `data_before`, `data_after`, `user_id`, `ts`)
* **Conflict** (`id`, `type`, `schedule_id?`, `payload_json`, `status` in {OPEN, RESOLVED}, `created_at`, `resolved_at?`)

### Индексы и ключи

* Уникальные: `Group.code`, `(Building.id, Room.number)`.
* Часто используемые индексы: по `Schedule.date`, `Schedule.group_id`, `Schedule.teacher_id`, `Schedule.room_id`, `TimeSlot.order_no`.
* Внешние ключи со strategy `ON UPDATE CASCADE`, `ON DELETE RESTRICT` для критичных справочников.

# 6) Правила и проверки (constraints engine)

При создании/генерации/редактировании пары система должна проверять (и возвращать детальные сообщения):

1. **Вместимость аудитории**: `group.students_count <= room.capacity`.
2. **Компьютеры**: если предмет/тип занятия требует ПК, то `room.computers_count >= group.students_count`.
3. **Занятость сущностей в слот**:

   * Преподаватель не ведёт уже другую пару в `date + time_slot`.
   * Группа не занята в `date + time_slot`.
   * Аудитория свободна в `date + time_slot`.
4. **Лимиты преподавателя**:

   * Не превышены `hours_per_week`.
   * Соответствие `TeacherAvailability` (нерабочие дни и окна времени).
5. **Учебный план**:

   * Часы по `Curriculum` не превышены/не «уходят в минус».
6. **Корпус/тип обучения**:

   * Соответствие корпуса (ВО/СПО) и пометок предмета/группы (если задано).
7. **Перерывы**:

   * Если между занятиями слот пуст — помечаем «перерыв» (на уровне UI формируется, БД хранит только реальные пары).

**Коды ошибок** (для API):
`ROOM_CAPACITY_EXCEEDED`, `ROOM_COMPUTERS_NOT_ENOUGH`, `TEACHER_BUSY`, `GROUP_BUSY`, `ROOM_BUSY`, `TEACHER_LIMIT_EXCEEDED`, `TEACHER_NOT_AVAILABLE`, `CURRICULUM_HOURS_EXCEEDED`, `INVALID_BUILDING`, …

# 7) Генерация расписания (planning)

* **Вход**: диапазон дат, целевые группы/преподаватели, исключения (праздники/мероприятия), приоритеты (например, сначала лекции, потом практики).
* **Данные**: `Assignments`, `Curriculum`, `TimeSlot`, `TeacherAvailability`, `WorkloadLimit`, `Rooms`.
* **Алгоритм (поэтапно, жадный + бэктрекинг при необходимости)**:

  1. Построить сетку рабочих дней и доступных слотов с учётом `Holiday` и `CalendarDay`.
  2. Сформировать очередь «требуемых пар» из `Curriculum` (остатки часов, часов/неделю).
  3. Для каждой требуемой пары подобрать `(date, slot, teacher, room)`:

     * Фильтр по доступности преподавателя, нерабочим дням.
     * Подбор аудитории по вместимости/типу/ПК.
     * Проверка занятостей (группа/преподаватель/аудитория).
  4. Если конфликты — пометить как `UNPLACED` с причинами (вернуть в предпросмотр).
* **Выход**: список новых `Schedule` + список конфликтов/невозможных назначений.
  Коммит в основную таблицу только после подтверждения админом.

# 8) Роли и права

* **Гость/Студент**: просмотр расписаний, поиск, автосохранение группы в браузере.
* **Преподаватель**: вход; просмотр своего календаря/статистики; назначение ДЗ; смена кабинета на своей паре (если свободен и удовлетворяет требованиям).
* **Админ**: полный CRUD справочников; настройка лимитов/доступности; назначения; генерация; редактор расписания; просмотр/закрытие конфликтов; импорты/экспорты.

# 9) Импорт/экспорт

* **Импорт CSV/XLSX**: группы, преподаватели, аудитории, учебные планы, назначения.
  Предпросмотр + маппинг колонок + dry-run с отчетом валидности.
* **Экспорт**: расписание на неделю по группе/преподавателю/корпусу; сводные отчёты часов, загрузки аудиторий; CSV/PDF.

# 10) Сессии без авторизации (важно по ТЗ)

* При первом заходе генерируем `visitor_id` (cookie, срок 180 дней).
* При выборе группы сохраняем в `localStorage` ключ `last_group`.
  На главной загружаем `/api/v1/schedule/group/<last_group>?date=today`, показываем сразу без кликов.
* Никакой PII — только код группы.

# 11) Цветовые схемы и отображение

* **Идёт сейчас** — акцентный фон/бордер, часы «сейчас».
* **Предстоит** — нейтральный фон.
* **Прошла** — приглушённый текст.
* **Дистанционка** — отдельный цвет бордера/пиктограмма «СДО».
* **Перерыв** — светлая плашка с текстом «перерыв 10:00–10:30».
* **Тип пары** — иконка + короткая метка (Л, П, З, Э).
* **Здание/корпус** — бейдж.

# 12) Нефункциональные требования

* **Производительность**: индексы на ключевых полях, пагинация в подсказках, кэширование часто запрашиваемых расписаний (на день/неделю).
* **Надёжность**: транзакции при массовой генерации, откат на конфликте, аудит изменений в `ChangeLog`.
* **Логи**: структурированные (request\_id, user\_id, action), хранение последних X дней.
* **Тесты**: юнит-тесты валидаторов и контроллеров, e2e на основные user-flows.
* **i18n** (опционально): текстовые константы в одном месте.
* **Деплой**: `.env` (DATABASE\_URL, SECRET\_KEY), gunicorn/waitress + reverse proxy, миграции Alembic.

# 13) Мини-чеклист для старта реализации

1. Поднять каркас Flask + Blueprints + SQLAlchemy + Migrate.
2. Реализовать модели: `Group`, `Teacher`, `Subject`, `Room`, `TimeSlot`, `Schedule`, базовые справочники.
3. Наполнить демо-данные (фикстуры).
4. Публичные API: `suggest`, `schedule/group`, `schedule/teacher`.
5. Главная + страница расписания с подсветкой состояний и перерывами.
6. Авторизация + роли (минимально).
7. Админ-CRUD по справочникам.
8. Слой `constraints` (минимальный набор проверок).
9. ЛК преподавателя: назначение ДЗ, смена кабинета (с проверками).
10. Генерация расписания (MVP) + предпросмотр + коммит.
11. Отчёты и импорты/экспорты (по мере необходимости).