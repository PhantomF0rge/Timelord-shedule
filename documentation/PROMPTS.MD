# 0) Макро-промпт для всего проекта (разово)

**Запрос:**

> Проект: модульный сайт-расписание колледжа. Flask + Blueprints, фронт — HTML+JS без фреймворков.
> Дай **полный каркас проекта**: структуру папок, `create_app`, регистрацию блюпринтов, базовые шаблоны, статику, `requirements.txt`, `config.py`, `extensions.py`, `wsgi.py`, пустые `routes.py / services.py / validators.py / schemas.py` для модулей:
> core, search, schedule, auth, directory, planning, constraints, homework, teacher, admin, reports, import\_export, api.
> Добавь **модели SQLAlchemy** и **миграции Alembic** для: User/Role, Teacher/Availability/WorkloadLimit, Group/EducationLevel, Subject, Building, RoomType, Room, LessonType, TimeSlot, Curriculum, Assignment, Schedule, Homework, Holiday, Conflict.
> Требования:
>
> 1. Регистрация блюпринтов + `url_prefix`.
> 2. Линтер/форматтер (чем проще, тем лучше — black/isort/flake8 опционально).
> 3. Минимальный `base.html`, `base.css`, `main.js`.
> 4. `GET /health`.
> 5. Инструкции запуска и команды миграций в README.
>    Выдай **дерево проекта** и **все файлы**. Если не помещается — раздели ответ на части (продолжи без повторов).

---

# 1) core

**Запрос:**

> Модуль `core` (Flask Blueprint): страницы `/` и `/health`, базовый шаблон, подключение статики, общие фильтры Jinja, инициализация логирования (структурные логи), cookie `visitor_id` (180 дней).
> Отдай: `core/routes.py`, фильтры, вставки в `base.html`, minimal CSS, JS-хелперы (localStorage.set/get last\_group).
> Приложи краткие тесты (pytest) на `/health` и установку `visitor_id`.

---

# 2) directory (справочники)

**Запрос:**

> Модуль `directory`: CRUD для групп, преподавателей, дисциплин, корпусов, типов аудиторий, аудиторий, типов занятий, слотов времени.
> Требования: уникальности `(building_id, number)`, `Group.code`, валидации числовых полей; пагинация, поиск `q`.
> Отдай:
>
> 1. `directory/routes.py` (страницы админ-UI) + формы HTML;
> 2. `api`-эндпоинты `GET/POST/PUT/DELETE` для каждого справочника;
> 3. схемы запросов/ответов;
> 4. миграции;
> 5. фикстуры демо-данных;
> 6. юнит-тесты CRUD + уникальные ограничения.

---

# 3) search (+ suggest)

**Запрос:**

> Модуль `search` + `api`: реализуй `GET /api/v1/suggest?q=&type=group|teacher|subject&limit=10` с индексами по `Group.code`, `Teacher.full_name`, `Subject.name`.
> Фронт: JS-виджет автодополнения (дебаунс 300мс, клавиатурная навигация, подсветка совпадений).
> Отдай: эндпоинт, сервис поиска, индексы, JS-виджет (чистый JS), небольшой CSS, и тесты на скорость (моки) и корректность.

---

# 4) schedule (публичное расписание)

**Запрос:**

> Модуль `schedule`:
>
> 1. `GET /api/v1/schedule/group/<code>?date=YYYY-MM-DD&range=day|week`
> 2. `GET /api/v1/schedule/teacher/<id>?date=...&range=...`
> 3. `GET /api/v1/lesson/<id>`
>    В ответ вставляй «перерывы» между слотами (is\_break), статусы `past/now/next/remote` (TZ Europe/Berlin).
>    Фронт: HTML-таблица с цветами, легенда, бейдж «СДО», отображение ДЗ.
>    Отдай: маршруты, сервис агрегации, вставку перерывов, SSR-шаблон, JS для переключения дня/недели, unit-тесты.

---

# 5) auth (роли и вход)

**Запрос:**

> Модуль `auth`: Flask-Login, роли `ADMIN`, `TEACHER`.
> Эндпоинты: `POST /api/v1/auth/login`, `POST /api/v1/auth/logout`.
> Требования: werkzeug security (hash), CSRF для POST-форм, базовый rate-limit на логин, декораторы `@admin_required`, `@teacher_required`.
> Отдай: маршруты, формы, шаблоны входа/ошибок, middleware, тесты: 401/403, успешный логин.

---

# 6) teacher (ЛК препода)

**Запрос:**

> Модуль `teacher`: страница `/teacher/me` с календарём (неделя/месяц), счётчики рабочих дней/часов/пар; список своих пар с быстрыми действиями.
> Требования: только для роли TEACHER; API для получения агрегатов; SSR + JS-подгрузка.
> Отдай: маршруты, сервисы расчётов, шаблоны, JS, тесты прав доступа и корректности агрегатов.

---

# 7) homework

**Запрос:**

> Модуль `homework`: `POST /api/v1/homework` (создать/обновить), поля `{lesson_id, text, deadline?}`; проверки «владелец пары» и «прошедшая пара» (настройка).
> Публичное расписание должно отображать ДЗ.
> Отдай: маршруты, сервис, валидации, миграции, unit-тесты (в т.ч. негативные).

---

# 8) constraints (проверки)

**Запрос:**

> Модуль `constraints`: сервис-движок проверок и `POST /api/v1/admin/constraints/check`.
> Проверяй: вместимость, ПК, занятость препода/группы/аудитории, лимит часов/неделю, доступность по дням/окнам, учебный план (остаток часов), (опц.) соответствие корпуса.
> Возвращай коды: `ROOM_CAPACITY_EXCEEDED`, `ROOM_COMPUTERS_NOT_ENOUGH`, `TEACHER_BUSY`, `GROUP_BUSY`, `ROOM_BUSY`, `TEACHER_LIMIT_EXCEEDED`, `TEACHER_NOT_AVAILABLE`, `CURRICULUM_HOURS_EXCEEDED`, `INVALID_BUILDING`.
> Отдай: сервис с изолированными функциями, маршруты, подробные `details`, юнит-тесты 100% покрытие на правила.

---

# 9) planning (генерация)

**Запрос:**

> Модуль `planning`:
>
> 1. `POST /api/v1/admin/planning/generate` (вход: `date_from/date_to`, списки групп/преподов, `honor_holidays`) → предпросмотр `{preview_id, proposed[], unplaced[]}`.
> 2. `GET /api/v1/admin/planning/preview?id=`
> 3. `POST /api/v1/admin/planning/commit`
>    Алгоритм: жадный подбор `(date, slot, teacher, room)` с вызовом `constraints`.
>    Отдай: сервис генерации (с возможностью подменить стратегию), хранение предпросмотра, миграции (если нужно), тест-набор с конфликтами.

---

# 10) admin (панель и редактор расписания)

**Запрос:**

> Модуль `admin`:
>
> 1. Дашборд `/admin` (счётчики, ближайшая неделя, открытые конфликты).
> 2. `/admin/directory/*` UI на CRUD (используй готовые API).
> 3. `/admin/schedule-editor` — редактор: создать/перенести/удалить пару, до сохранения дергать `constraints.check`.
> 4. Журнал изменений (минимум): кто/что/когда.
>    Отдай: HTML+JS (drag\&drop можно упрощённо), интеграция с API, сообщения об ошибках, e2e-тесты критических сценариев.

---

# 11) reports (экспорт)

**Запрос:**

> Модуль `reports`: CSV-экспорты
>
> * расписание на неделю (по группе/преподавателю/корпусу),
> * рабочие часы преподавателей,
> * загрузка аудиторий.
>   Отдай: маршруты, сервис агрегации, формат CSV (разделитель `;`, UTF-8), юнит-тесты на корректность и порядок колонок.

---

# 12) import\_export (импорт)

**Запрос:**

> Модуль `import_export`: импорт CSV для групп, преподавателей, аудиторий, учебных планов.
> Функции: предпросмотр, маппинг колонок, dry-run, отчёт об ошибках/дубликатах, atomic-commit при успехе.
> Отдай: страницы, API, валидатор, примеры CSV, тесты (в т.ч. на уникальные ограничения и rollback).

---

# 13) api (документация)

**Запрос:**

> Модуль `api`: собери **единый документ API** (Markdown): список эндпоинтов, параметры, JSON-схемы запросов/ответов, коды ошибок, примеры.
> Приложи OpenAPI 3.0 (yaml) **минимально совместимый** с текущими эндпоинтами.
> Отдай: `docs/api.md`, `docs/openapi.yaml`.

---

## Сквозные промпты (повторно используемые)

### A) Юнит-тесты и фикстуры

**Запрос:**

> Напиши unit-тесты pytest для модуля `<module_name>`: покрытия ≥ 80%, фикстуры (демо-данные), моки БД/времени, негативные кейсы (ошибки валидаций, 401/403, 409). Дай команды запуска.

### B) Производительность

**Запрос:**

> Оптимизируй запросы `<module_name>`: проверь N+1, добавь индексы, покажи EXPLAIN (логика) и тест производительности на демо-объёме. Верни список индексов и где они создаются (миграции).

### C) UI-полировка

**Запрос:**

> Улучши UI `<page>`: чёткая типографика, тёмная тема, адаптив, видимые состояния (loading/empty/error), не «дрожит» при подгрузке, клавиатурная навигация. Дай HTML/CSS/JS.

### D) Дифф-обновления

**Запрос:**

> У меня уже есть файлы `<path>`. Сгенерируй **патч-дифф** (unified diff) для правок: `<кратко что поменять>`. Не повторяй неизменённые файлы. Объясни, куда вставлять.

### E) Демо-данные

**Запрос:**

> Сгенерируй фикстуры демо-данных: 6 групп (SPO/VO), 12 преподавателей, 15 дисциплин, 2 корпуса, 24 аудитории (разные типы/вместимость/ПК), 6 слотов времени, учебные планы, назначения, недельное расписание без конфликтов. Дай SQL/скрипт seed, и CSV для импорта.
