# Таймлайн проекта (MVP за 8 недель)

**Период:** 08.09.2025 → 31.10.2025 (Европа/Калининград)

| Неделя | Даты          | Цели                                   | Основные артефакты и проверки                                                                                                                                                             |
| ------ | ------------- | -------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| **W1** | 08–12 сеп     | Каркас и базовые справочники           | Каркас Flask + Blueprints; модели `Group/Teacher/Subject/Room/TimeSlot/LessonType`; миграции; базовая главная страница; `GET /api/v1/suggest`; фикстуры демо-данных; линтеры; smoke-тесты |
| **W2** | 15–19 сеп     | Публичное чтение расписания            | `GET /api/v1/schedule/group`, `…/teacher`, вставка «перерывов»; серверные шаблоны таблицы; фронтовые статусы (past/now/next/remote); автосохранение `last_group` (localStorage)           |
| **W3** | 22–26 сеп     | Авторизация и ЛК препода (MVP) + ДЗ    | Логин/логаут; `/teacher/me`; `POST /api/v1/homework`; отображение ДЗ на публичных страницах; контроль «владелец пары»                                                                     |
| **W4** | 29 сеп–03 окт | Админ-CRUD по справочникам             | Страницы `/admin/directory/*`; API CRUD для групп, преп., дисциплин, корпусов/аудиторий/типов, слотов; поиск; журнал изменений (минимум)                                                  |
| **W5** | 06–10 окт     | Движок ограничений (v1)                | `constraints`-сервис: вместимость, ПК, занятость учителя/аудитории/группы, доступность и недельные лимиты часов; `POST /api/v1/admin/constraints/check`; тест-наборы                      |
| **W6** | 13–17 окт     | Генерация расписания (черновик)        | `POST /admin/planning/generate` (предпросмотр), `GET /…/preview`; визуал админа: список предложений/ошибок до коммита                                                                     |
| **W7** | 20–24 окт     | Коммит генерации + редактор расписания | `POST /admin/planning/commit`; ручной редактор пары (создать/перенести/удалить) с онлайновой проверкой; смена кабинета преподом (`change-room`)                                           |
| **W8** | 27–31 окт     | Полировка, отчёты, импорт/экспорт      | Экспорт CSV расписаний/нагрузки; базовый импорт CSV справочников; оптимизация запросов и индексы; мониторинг/логи; E2E-регресс                                                            |

**Майлстоны:**

* **M1 (W2)**: публичный поиск и расписания работают, перерывы и цвета есть, last\_group запоминается.
* **M2 (W4)**: админ может управлять справочниками через UI, все CRUD-операции.
* **M3 (W6)**: генерация создаёт предпросмотр без записи, видны причины непроставленных пар.
* **M4 (W8)**: редактор расписания, коммит, смена кабинета, отчёты/экспорт — готово.

**Риски и буферы:**

* Сложность ограничений → держим 20% буфера W5–W7 (часть W8).
* Качество исходных данных → закладываем импорт-валидацию и dry-run.
* Производительность подсказок → индексы + лимит `limit<=10` + дебаунс 300 мс.

---

# План разработки модулей (очередность, состав работ, DoD)

Ниже — порядок реализации. Для каждого: **Scope**, **Задачи**, **Зависимости**, **DoD (Definition of Done)**.

## 1) `core`

* **Scope:** базовый каркас, шаблон `base.html`, health, статика, конфиг.
* **Задачи:** настройка `create_app`, регистрация блюпринтов, base-шаблон, базовые стили/JS, `/health`.
* **Зависимости:** нет.
* **DoD:** приложение стартует, логи структурированы, статика отдается, `GET /health -> {"status":"ok"}`.

## 2) `directory` (справочники)

* **Scope:** группы, преподаватели, дисциплины, корпуса, аудитории/типы, слоты, типы занятий.
* **Задачи:** модели + миграции; API CRUD; админ-страницы с поиском/пагинацией; валидации уникальности.
* **Зависимости:** core, models.
* **DoD:** все CRUD-эндпоинты возвращают 200/201/204; уникальные индексы; фикстуры.

## 3) `search` + `api` (подсказки)

* **Scope:** `/api/v1/suggest` и фронтовый виджет автодополнения.
* **Задачи:** индексы на `code/name/full_name`; дебаунс; подсветка совпадений.
* **Зависимости:** directory.
* **DoD:** RPS 50+ на подсказках, p95 < 120 мс на демо-данных; корректный тип результата.

## 4) `schedule` (публичное чтение)

* **Scope:** `GET /schedule/group|teacher`, вставка «перерывов», статусы past/now/next/remote.
* **Задачи:** вычисление статуса на сервере (с учётом TZ); генерация break-строк на основе сетки слотов.
* **Зависимости:** directory, search.
* **DoD:** корректное формирование «перерывов» и статусов; покрытие юнит-тестами 80%+.

## 5) `auth`

* **Scope:** логин/логаут, роли `ADMIN/TEACHER`.
* **Задачи:** Flask-Login, хранение пароля hash, middleware для админ-API.
* **Зависимости:** core.
* **DoD:** защищённые эндпоинты возвращают 401/403 без сессии; успешный вход создаёт сессию.

## 6) `teacher` + `homework`

* **Scope:** ЛК преподавателя: календарь, счётчики, ДЗ; смена кабинета.
* **Задачи:** `POST /homework`, `POST /lesson/<id>/change-room`; страницы `/teacher/me` и форма ДЗ.
* **Зависимости:** auth, schedule, constraints (для change-room).
* **DoD:** владелец пары может задать ДЗ/сменить кабинет; чужой — 403; ДЗ видно на публичной странице.

## 7) `constraints`

* **Scope:** проверки: вместимость, ПК, занятость сущностей, доступность, недельные лимиты, учебный план.
* **Задачи:** сервис-функции + `POST /admin/constraints/check` с детальными кодами ошибок.
* **Зависимости:** directory, schedule, curricula/assignments.
* **DoD:** набор тест-кейсов на каждую проверку; стабильные коды ошибок (см. ТЗ).

## 8) `planning` (генерация)

* **Scope:** предпросмотр расписания за период; коммит в основную таблицу.
* **Задачи:** жадный подбор слота/аудитории/препода с вызовом `constraints`; хранение `preview` в памяти/таблице; `commit`.
* **Зависимости:** constraints, directory, schedule.
* **DoD:** на тестовом наборе генерирует ≥80% назначений без конфликтов; предпросмотр и коммит разделены.

## 9) `admin` (UI)

* **Scope:** панель, редактор расписания (create/drag/drop/update/delete), визуал конфликтов.
* **Задачи:** UI-страницы; вызовы `constraints.check` на on-change; отображение ошибок до сохранения.
* **Зависимости:** planning, constraints, schedule.
* **DoD:** любую пару можно перенести/создать с онлайн-валидацией; конфликты подсвечены и фильтруемы.

## 10) `reports` + `import_export`

* **Scope:** выгрузка CSV расписаний и нагрузки; импорт CSV справочников (dry-run).
* **Задачи:** эндпоинты выгрузки; парсер CSV; предпросмотр маппинга колонок; отчёты по часам/аудиториям.
* **Зависимости:** directory, schedule.
* **DoD:** корректные CSV; импортер валидирует и не ломает уникальные ключи; логи операций.

---

# Требования к модулям по ТЗ (детализировано)

## A. Публичный поиск и выдача (search + schedule)

* **Функционал:**

  * Поиск по **группам, преподавателям, дисциплинам**; подсказки по мере ввода (≤10 элементов).
  * Страница расписания группы/преподавателя: **название дисциплины, ФИО препода, время начала/конца, № пары, аудитория/СДО, тип пары, здание, ДЗ**.
  * **Перерывы** между парами показываются как отдельные строки «перерыв HH\:MM–HH\:MM».
  * **Подсветка:** идёт сейчас / предстоящие / прошедшие / дистанционка — разными стилями.
* **Нефункциональные:**

  * Подсказки p95 < 120 мс на демо-объёме (индексы + лимит).
  * Кэш ETag на расписания (день/неделя).
* **DoD:** ручные сценарии: «найти группу → увидеть расписание на сегодня», «поиск по преподу», «переключение на неделю».

## B. Сессии без авторизации (core + фронт)

* **Функционал:** cookie `visitor_id` (180 дней), `localStorage.last_group`.
* **Поведение:** при следующем входе — показать «сегодня для last\_group».
* **DoD:** e2e-тест: выбрать группу, перезагрузить/очистить куки (кроме localStorage) — группа восстановлена.

## C. Авторизация и роли (auth)

* **Функционал:** логин/логаут; доступ к `/admin/*` и действиям препода только для соответствующих ролей.
* **Безопасность:** хэш пароля (bcrypt/werkzeug), защита от brute force (базовая задержка), CSRF для POST в браузере.
* **DoD:** без сессии — 401/403 на защищённых эндпоинтах.

## D. Справочники (directory)

* **Функционал (CRUD):** группы (с численностью и уровнем), преподаватели, дисциплины (флаг «нужны ПК»), корпуса, аудитории (вместимость, тип, ПК), типы занятий, слоты времени.
* **Ограничения:** `(building_id, number)` уникален; `Group.code` уникален; отрицательные значения запрещены.
* **DoD:** формы создают/редактируют; уникальные конфликты ловятся на уровне БД и API.

## E. Ограничения и проверки (constraints)

* **Проверять:**

  1. вместимость аудитории >= численности группы;
  2. ПК в аудитории >= численности группы, если предмет/тип «требует ПК»;
  3. занятость преподавателя/группы/аудитории в `date+slot`;
  4. лимит часов преподавателя/неделю;
  5. доступность (рабочие окна, «выходные»);
  6. учебный план: не превышать `total_hours` (и, если задано, `hours_per_week`);
  7. (опц.) соответствие корпуса уровню (ВО/СПО).
* **API:** `POST /api/v1/admin/constraints/check` → `{ok:boolean, violations:[{code, message, details}]}`; коды из фиксированного списка.
* **DoD:** 100% покрытие тестами на отдельные правила; интеграционный набор «комбинированные конфликты».

## F. Генерация расписания (planning)

* **Вход:** диапазон дат, списки групп/преподавателей (фильтры), флаги «учитывать праздники».
* **Алгоритм:** жадный подбор (слот → преподаватель → аудитория) с вызовами `constraints`, возврат **предпросмотра** и списка **unplaced** с причинами.
* **Выход:** `preview_id`, `proposed[]`, `unplaced[]`; отдельный `commit`.
* **DoD:** на тестовом наборе заполняет основную долю слотов, все ошибки формализованы.

## G. Редактор расписания и смена кабинета (admin + teacher)

* **Редактор:** создать/перенести/удалить; онлайн-валидация через `constraints.check` до сохранения; журнал изменений.
* **Смена кабинета:** `POST /lesson/<id>/change-room` доступно владельцу пары; все проверки из constraints.
* **DoD:** любой конфликт отображается до записи; успешные изменения видны публично.

## H. Домашнее задание (homework)

* **Функционал:** назначение/редактирование ДЗ преподавателем; отображение на публичной выдаче пары.
* **Правила:** изменять может только владелец пары; для прошедших пар — ограничение (по настройке).
* **DoD:** создать/обновить ДЗ; видеть на публичной странице; права соблюдены.

## I. Импорт/экспорт и отчёты (import\_export + reports)

* **Импорт CSV:** группы, преподаватели, аудитории, планы (минимум); предпросмотр/валидатор/dry-run; отчёт об ошибках.
* **Экспорт CSV:** расписания на неделю (по группе/преподу/корпусу), рабочие часы преподавателей, загрузка аудиторий.
* **DoD:** корректные файлы, устойчивость к дубликатам/пропускам, понятные сообщения об ошибках.

---

# Критерии готовности (сквозные)

* **Качество кода:** линтеры/форматтеры; модульные тесты ≥ 70% в MVP; обязательные интеграционные на constraints, генерацию и редактор.
* **Миграции:** каждая модель/поле — через Alembic; reproducible фикстуры.
* **Производительность:** подсказки p95 < 120 мс; выдача расписания p95 < 200 мс на демо-объёме; N+1 устранены.
* **UX:** без JS всё читаемо (SSR), с JS — автоподсказки, цвета статусов, плавное переключение дня/недели.
* **Логи и аудит:** структурированные логи (action, user\_id, entity); `ChangeLog` на CRUD и правки расписания.
* **Безопасность:** роли, CSRF для форм, пароли в hash, защита от инъекций (ORM), rate-limit на логин (базовый).

---

# Мини-тест-план (что проверяем)

1. **Публичка:** поиск группы → расписание на сегодня; подсказки корректны; перерыв между 2-й и 4-й парами вставился.
2. **Сессии:** выбрать группу → обновить страницу → нужная группа показана автоматически.
3. **Авторизация:** без сессии — 401 на `/admin/...`; преподаватель видит только свои пары.
4. **Constraints:** аудитория с capacity < group → ошибка `ROOM_CAPACITY_EXCEEDED`; занятые сущности; недостаточно ПК.
5. **Teacher:** назначить ДЗ; сменить кабинет на свободный → успех; на занятый → `ROOM_BUSY`.
6. **Генерация:** предпросмотр+commit; unplaced содержит причины.
7. **Редактор:** перенос пары через UI с онлайновой проверкой.
8. **Экспорт/импорт:** корректные CSV; dry-run показывает нарушения уникальности.